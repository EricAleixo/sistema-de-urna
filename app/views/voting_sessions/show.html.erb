<% content_for :head do %>
  <%= stylesheet_link_tag "voting_sessions", media: "all" %>
<% end %>

<div class="voting-session-container">
  <div class="session-wrapper">
    <!-- Header -->
    <div class="session-header">
      <div class="header-left">
        <div class="header-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div class="header-content">
          <h1 class="page-title">Painel de Controle</h1>
          <p class="page-subtitle">Gerenciamento de Votação em Tempo Real</p>
        </div>
      </div>
      <div class="status-badge <%= @session.status %>">
        <span class="status-dot"></span>
        <span class="status-label"><%= @session.status.upcase %></span>
      </div>
    </div>

    <!-- Session Info Grid -->
    <div class="info-section">
      <div class="info-card primary">
        <div class="info-icon-wrapper">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <line x1="9" y1="3" x2="9" y2="21"/>
          </svg>
        </div>
        <div class="info-data">
          <span class="info-value">#<%= @session.id %></span>
          <span class="info-label">ID da Sessão</span>
        </div>
      </div>

      <div class="info-card secondary">
        <div class="info-icon-wrapper">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div class="info-data">
          <span class="info-value"><%= @turma.nome %></span>
          <span class="info-label">Turma</span>
        </div>
      </div>

      <div class="info-card accent">
        <div class="info-icon-wrapper">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <div class="info-data">
          <span class="info-value" id="total-votos"><%= @total_votos %></span>
          <span class="info-label">Total de Votos</span>
        </div>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="controls-section">
  <% if @session.status != 'closed' %>
    <button type="button"
            id="toggle-status-btn"
            class="control-btn <%= @session.status == 'open' ? 'btn-pause' : 'btn-resume' %>"
            data-url="<%= toggle_status_voting_session_path(@session) %>"
            data-status="<%= @session.status %>">
      <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <% if @session.status == 'open' %>
          <rect x="6" y="4" width="4" height="16"/>
          <rect x="14" y="4" width="4" height="16"/>
        <% else %>
          <polygon points="5 3 19 12 5 21 5 3"/>
        <% end %>
      </svg>
      <span class="btn-text"><%= @session.status == 'open' ? 'Pausar Votação' : 'Retomar Votação' %></span>
    </button>

    <%= button_to close_voting_session_path(@session), 
        method: :patch, 
        class: "control-btn button-close",
        data: { confirm: "Atenção!\n\nDeseja realmente encerrar esta sessão?\nEsta ação é irreversível." } do %>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <span>Encerrar Sessão</span>
    <% end %>
  <% else %>
  <%= button_to open_voting_open_one_session_path(@session), 
        method: :patch, 
        class: "control-btn retomar-button",
        data: { confirm: "Atenção!\n\nRetome a ação " } do %>
      <i class="bi bi-unlock"></i>
      <span>Retomar sessão</span>
    <% end %>
    <div class="session-finished">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
      <span>Sessão encerrada com Sucesso</span>
    </div>
  <% end %>
</div>
    <!-- Preview rápido quando encerrada (opcional) -->
    <div class="empty-state">
      <div class="empty-icon">
        <i class="bi bi-check-circle-fill" style="font-size: 64px; color: #10b981;"></i>
      </div>
      <h3 class="empty-title">Sessão Encerrada</h3>
      <%= link_to "Resultados", resultados_voting_session_path(@session), class: "btn-resultados" %>
      <p class="empty-description">
        A votação foi concluída com sucesso! Clique no botão acima para visualizar 
        a apuração completa dos votos e a classificação final dos candidatos.
      </p>
      
      <!-- Stats rápidas -->
      <div style="margin-top: 2rem; display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
        <div style="text-align: center;">
          
          <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600; text-transform: uppercase;">
            Total de Votos
          </div>
        </div>
        
        <div style="text-align: center;">
          
          <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600; text-transform: uppercase;">
            Candidatos
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div class="footer-section">
      <%= link_to "", class: "back-link" do %>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
        <span>Voltar ao Início</span>
      <% end %>
    </div>
  </div>
</div>

<script type="module">
  import "channels/voting_session_channel"
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleButton = document.getElementById('toggle-status-btn');
  const statusBadge = document.querySelector('.status-badge');
  const statusLabel = statusBadge?.querySelector('.status-label');
  

  if (toggleButton) {
    toggleButton.addEventListener('click', function(e) {
      e.preventDefault();
      
      const url = this.dataset.url;
      const currentStatus = this.dataset.status;
      
      // Desabilita o botão temporariamente
      toggleButton.disabled = true;
      toggleButton.style.opacity = '0.6';
      
      // Faz a requisição AJAX
      fetch(url, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const newStatus = data.status;
          
          // Atualiza o badge de status
          if (statusBadge && statusLabel) {
            statusBadge.className = 'status-badge ' + newStatus;
            statusLabel.textContent = newStatus.toUpperCase();
          }
          
          // Atualiza o botão
          updateToggleButton(newStatus);
          
          // Mostra notificação de sucesso
          showNotification(data.message, 'success');
        } else {
          showNotification(data.message || 'Erro ao atualizar sessão', 'error');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        showNotification('Erro ao comunicar com o servidor', 'error');
      })
      .finally(() => {
        // Reabilita o botão
        toggleButton.disabled = false;
        toggleButton.style.opacity = '1';
      });
    });
  }
  
  function updateToggleButton(status) {
    const button = document.getElementById('toggle-status-btn');
    const icon = button.querySelector('.btn-icon');
    const text = button.querySelector('.btn-text');
    
    if (status === 'open') {
      // Mudar para botão de PAUSAR
      button.className = 'control-btn btn-pause';
      button.dataset.status = 'open';
      icon.innerHTML = `
        <rect x="6" y="4" width="4" height="16"/>
        <rect x="14" y="4" width="4" height="16"/>
      `;
      text.textContent = 'Pausar Votação';
    } else if (status === 'paused') {
      // Mudar para botão de RETOMAR
      button.className = 'control-btn btn-resume';
      button.dataset.status = 'paused';
      icon.innerHTML = `<polygon points="5 3 19 12 5 21 5 3"/>`;
      text.textContent = 'Retomar Votação';
    }
  }
  
  function showNotification(message, type) {
    // Criar elemento de notificação
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: ${type === 'success' ? '#10b981' : '#ef4444'};
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-weight: 500;
      animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(notification);
    
    // Remove após 3 segundos
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
});

// Animações para notificação
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);
</script>